import moment from 'moment';
import { faker } from '@faker-js/faker';

export interface CreateCdrVulnerabilityParams {
  vulnerabilityId: string;
  resourceId: string;
  packageName: string;
  packageVersion: string;
  space?: string;
  hostname?: string;
  username?: string;
}

/**
 * Creates a CDR vulnerability document compatible with the wiz vulnerability schema.
 * Based on the wiz integration transform: security_solution-wiz.vulnerability_latest
 *
 * Uniqueness is determined by: vulnerability.id, resource.id, vulnerability.package.name,
 * vulnerability.package.version, data_stream.namespace
 */
export function createCdrVulnerability({
  vulnerabilityId,
  resourceId,
  packageName,
  packageVersion,
  space = 'default',
  hostname,
  username,
}: CreateCdrVulnerabilityParams) {
  const now = moment().format('yyyy-MM-DDTHH:mm:ss.SSSSSSZ');
  const firstDetected = moment().subtract(faker.number.int({ min: 1, max: 90 }), 'days').toISOString();
  const dataset = 'wiz.vulnerability';

  const hostName = hostname || faker.internet.domainName();
  const userName = username || faker.internet.username();
  const severity = faker.helpers.arrayElement(['LOW', 'MEDIUM', 'HIGH', 'CRITICAL']);
  const score = faker.number.float({ min: 1.0, max: 10.0, fractionDigits: 1 });
  const fixedVersion = `${packageVersion.split('.').slice(0, -1).join('.')}.${faker.number.int({ min: 1, max: 99 })}`;
  const accountId = faker.string.numeric(12);
  const region = faker.helpers.arrayElement(['us-east-1', 'us-west-2', 'eu-west-1', 'ap-southeast-1']);
  const cloudProvider = faker.helpers.arrayElement(['AWS', 'GCP', 'Azure']);
  const subscriptionId = faker.string.uuid();

  return {
    '@timestamp': now,
    agent: {
      ephemeral_id: faker.string.uuid(),
      id: faker.string.uuid(),
      name: `elastic-agent-${faker.string.alphanumeric(5)}`,
      type: 'filebeat',
      version: '8.18.0',
    },
    cloud: {
      account: {
        id: accountId,
        name: faker.company.name().toLowerCase().replace(/\s+/g, '-'),
      },
      provider: cloudProvider,
      region: region,
    },
    data_stream: {
      dataset,
      namespace: space,
      type: 'logs',
    },
    device: {
      id: faker.string.uuid(),
    },
    ecs: {
      version: '8.11.0',
    },
    elastic_agent: {
      id: faker.string.uuid(),
      snapshot: false,
      version: '8.18.0',
    },
    event: {
      agent_id_status: 'verified',
      category: ['vulnerability'],
      created: now,
      dataset,
      id: faker.string.uuid(),
      ingested: now,
      kind: 'alert',
      type: ['info'],
    },
    host: {
      name: hostName,
      os: {
        family: 'Linux',
      },
    },
    message: `The package \`${packageName}\` version \`${packageVersion}\` is vulnerable to \`${vulnerabilityId}\`. The vulnerability can be remediated by updating to version \`${fixedVersion}\` or higher.`,
    observer: {
      vendor: 'Wiz',
    },
    package: {
      fixed_version: fixedVersion,
      name: packageName,
      version: packageVersion,
    },
    related: {
      ip: [faker.internet.ip(), faker.internet.ip()],
    },
    resource: {
      id: resourceId,
      name: hostName,
    },
    tags: [
      'preserve_original_event',
      'preserve_duplicate_custom_fields',
      'forwarded',
      'wiz-vulnerability',
    ],
    user: {
      name: userName,
    },
    vulnerability: {
      cwe: vulnerabilityId,
      description: faker.lorem.paragraph(),
      id: vulnerabilityId,
      package: {
        fixed_version: fixedVersion,
        name: packageName,
        version: packageVersion,
      },
      reference: `https://nvd.nist.gov/vuln/detail/${vulnerabilityId}`,
      score: {
        base: score,
        version: '3.1',
      },
      severity: severity,
      title: `Vulnerability found - ${vulnerabilityId}`,
    },
    wiz: {
      vulnerability: {
        cve_description: faker.lorem.paragraph(),
        cvss_severity: severity,
        data_source_name: 'NVD',
        description: `The package \`${packageName}\` version \`${packageVersion}\` is vulnerable to \`${vulnerabilityId}\`.`,
        detailed_name: packageName,
        detection_method: 'PACKAGE',
        epss: {
          percentile: faker.number.float({ min: 0, max: 100, fractionDigits: 1 }),
          probability: faker.number.float({ min: 0, max: 1, fractionDigits: 2 }),
          severity: faker.helpers.arrayElement(['LOW', 'MEDIUM', 'HIGH']),
        },
        exploitability_score: faker.number.float({ min: 0, max: 4, fractionDigits: 1 }),
        first_detected_at: firstDetected,
        fixed_version: fixedVersion,
        has_cisa_kev_exploit: faker.datatype.boolean(),
        has_exploit: faker.datatype.boolean(),
        id: faker.string.uuid(),
        impact_score: faker.number.float({ min: 0, max: 6, fractionDigits: 1 }),
        last_detected_at: now,
        link: `https://nvd.nist.gov/vuln/detail/${vulnerabilityId}`,
        location_path: `package/library/${packageName}`,
        name: vulnerabilityId,
        portal_url: `https://app.wiz.io/explorer/vulnerability-findings#~(entity~(~'${faker.string.uuid()}))`,
        projects: [
          {
            id: faker.string.uuid(),
            name: faker.company.name(),
            risk_profile: {
              business_impact: faker.helpers.arrayElement(['LBI', 'MBI', 'HBI']),
            },
            slug: faker.lorem.slug(),
          },
        ],
        remedation: `Update ${packageName} to version ${fixedVersion}`,
        score: score,
        status: faker.helpers.arrayElement(['OPEN', 'RESOLVED', 'IN_PROGRESS']),
        validated_in_runtime: faker.datatype.boolean(),
        vendor_severity: severity,
        version: packageVersion,
        vulnerable_asset: {
          cloud: {
            platform: cloudProvider,
            provider_url: `https://${region}.console.aws.amazon.com/ec2/v2/home?region=${region}`,
          },
          has_limited_internet_exposure: faker.datatype.boolean(),
          has_wide_internet_exposure: faker.datatype.boolean(),
          id: faker.string.uuid(),
          ip_addresses: [faker.internet.ip(), faker.internet.ip()],
          is_accessible_from: {
            other_subscriptions: faker.datatype.boolean(),
            other_vnets: faker.datatype.boolean(),
            vpn: faker.datatype.boolean(),
          },
          name: hostName,
          operating_system: 'Linux',
          provider_unique_id: resourceId,
          region: region,
          status: 'Active',
          subscription: {
            external_id: accountId,
            id: subscriptionId,
            name: faker.company.name().toLowerCase().replace(/\s+/g, '-'),
          },
          tags: {
            name: hostName,
          },
          type: 'VIRTUAL_MACHINE',
        },
      },
    },
  };
}
